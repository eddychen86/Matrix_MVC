<div v-cloak v-show="replyModal.visible" class="fixed inset-0 z-[999] flex items-center justify-center" style="display:none;">
    <div class="absolute inset-0 bg-black/50" v-on:click="closeReply()"></div>

    <div class="relative z-[1000] flex h-[80vh] max-h-[800px] min-h-[650px] items-stretch">

        <!-- 左側：文章 -->
        <div class="relative flex h-full max-w-[650px] min-w-[450px] flex-col overflow-hidden rounded-[15px] bg-[#161616] p-6 pt-[70px]">
            <template v-if="replyModal.article">
                <!-- 頭像 -->
                <img :src="replyModal.article.authorAvatar || '/static/images/default_avatar.png'"
                     class="absolute top-[25px] left-[24px] h-[32px] w-[34px] rounded-[24px] object-cover object-center"
                     alt="" />
                <!-- 名稱 -->
                <div class="absolute top-[30px] left-[69px] text-white text-[18px] font-['Roboto'] leading-[22px]">
                    {{ replyModal.article.authorName || '未知作者' }}
                </div>
            </template>

            <!-- 關閉 -->
            <button v-on:click="closeReply()" class="absolute top-[22px] right-[24px] h-[32px] w-[32px] text-white hover:text-gray-300">
                <svg viewBox="0 0 24 24" class="h-full w-full fill-current">
                    <path d="M6 6 L18 18 M6 18 L18 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                </svg>
            </button>

            <!-- 主要內容 -->
            <div class="flex flex-1 flex-col gap-4 pt-[10px] pb-[90px]">
                <p class="leading-7 break-words whitespace-pre-wrap">
                    {{ replyModal.article?.content }}
                </p>

                <!-- 圖片附件 -->
                <div v-if="replyModal.article?.attachments?.some(f => f.type === 'image')" class="mt-4">
                    <div class="flex flex-wrap gap-2">
                        <img v-for="img in replyModal.article.attachments.filter(f => f.type === 'image')"
                             :key="img.fileId"
                             :src="img.filePath"
                             class="rounded-lg max-h-35 max-w-full object-contain">
                    </div>
                </div>

                <!-- 非圖片附件 -->
                <div v-if="replyModal.article?.attachments?.some(f => f.type !== 'image')" class="flex flex-wrap items-end gap-2">
                    <a v-for="(file, index) in replyModal.article.attachments.filter(f => f.type !== 'image')"
                       :key="file.fileId || index"
                       :href="file.filePath"
                       target="_blank"
                       class="relative w-[60px] shrink-0 rounded-[12px] bg-white/5 p-1"
                       :title="file.fileName || (file.filePath || '').split('/').pop()">
                        <div class="flex h-[40px] w-full items-center justify-center rounded-[10px] bg-white">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24">
                                <path fill="none" d="M0 0h24v24H0z"></path>
                                <path fill="currentColor"
                                      d="m20.41 8.41-4.83-4.83c-.37-.37-.88-.58-1.41-.58H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V9.83c0-.53-.21-1.04-.59-1.42zM7 7h7v2H7V7zm10 10H7v-2h10v2zm0-4H7v-2h10v2z">
                                </path>
                            </svg>
                        </div>
                        <span class="mt-1 block max-w-full text-center break-words text-[11px]">
                            {{ file.fileName || (file.filePath || '').split('/').pop() }}
                        </span>
                    </a>
                </div>
            </div>

            <!-- hashtag -->
            <div v-if="replyModal.article?.hashtags?.length"
                 class="mt-4 flex flex-wrap gap-2">
                <span v-for="tag in replyModal.article.hashtags"
                      :key="tag.tagId"
                      class="rounded-full bg-white/10 px-3 py-1 text-sm whitespace-nowrap text-white">
                    #{{ tag.name }}
                </span>
            </div>

            <!-- 按讚&收藏 -->
            <div class="post-content_state">
                <button class="text-white/90 hover:text-white">
                    <i data-lucide="heart" class="size-4"></i>
                    <span>{{ replyModal.article?.praiseCount || 0 }}</span>
                </button>
                <button class="text-white/90 hover:text-white">
                    <i data-lucide="bookmark" class="size-4"></i>
                    <span>{{ replyModal.article?.collectCount || 0 }}</span>
                </button>
            </div>
        </div>

        <!-- 右側：留言 -->
        <div class="relative flex h-full w-[400px] overflow-hidden rounded-[15px] bg-white">
            <div class="flex w-full flex-col">
                <div class="flex items-center justify-between border-b border-white/10 px-4 py-3">
                    <div class="text-base font-medium text-black">留言</div>
                </div>

                <!-- 留言清單 -->
                <div class="flex-1 space-y-3 overflow-y-auto px-4 py-3">
                    <div v-if="replyModal.loading" class="flex flex-col items-center gap-2 text-gray-600">
                        <img src="~/static/img/Loading.gif" alt="Loading" class="h-12 w-12" />
                        <span>載入中…</span>
                    </div>
                    <div v-else-if="!replyModal.replies.length" class="text-gray-600">還沒有留言</div>
                    <div v-for="reply in replyModal.replies" :key="reply.replyId" class="rounded-lg bg-gray-300 p-3">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <img :src="reply.authorAvatar || '/static/img/default_avatar.png'"
                                     class="h-7 w-7 rounded-full object-cover"
                                     alt="avatar"
                                     v-on:error="e => e.target.src='/static/img/default_avatar.png'" />
                                <div class="text-sm font-bold text-black">
                                    {{ reply.authorName || '未知作者' }}
                                </div>
                            </div>
                            <div class="text-xs text-gray-600">
                                {{ reply.createTimeFormatted || formatDate(reply.createTime, 'YYYY-MM-DD HH:mm') }}
                            </div>
                        </div>
                        <div class="mt-2 text-sm whitespace-pre-wrap text-black">{{ reply.content }}</div>
                    </div>

                </div>

                <!-- 新增留言 -->
                <div class="border-t border-white/10 p-3">
                    <div class="flex items-end gap-2">
                        <textarea v-model="replyModal.newComment"
                                  rows="1"
                                  class="placeholder-white/40 h-auto max-h-40 min-h-[2.5rem] w-full resize-none overflow-auto rounded-[15px] bg-[#131313] p-2 text-white outline-none [field-sizing:content]"
                                  placeholder="寫點什麼吧…"></textarea>
                        <button v-on:click="submitReply"
                                class="min-h-[2.5rem] shrink-0 rounded-full bg-gray-700 px-3 py-2 text-sm font-medium text-white hover:from-[#162534]"
                                :disabled="replyModal.submitting">
                            {{ replyModal.submitting ? '送出中…' : '送出' }}
                        </button>
                    </div>
                    <div v-if="replyModal.error" class="mt-2 text-xs text-red-400">{{ replyModal.error }}</div>
                </div>
            </div>
        </div>

    </div>
</div>

<div id="popup-wrapper" style="display:none;">
    <!-- Universal Popup Modal -->
    <div id="popup-overlay" v-if=" popupState.isVisible" @@click="closePopup"
        class="fixed inset-0 flex h-screen w-screen items-center justify-center bg-black/50" style="z-index: 99999;">
        <div id="popup-container" @@click.stop=""
            class="max-h-[80vh] w-4/5 overflow-hidden rounded-[30px] bg-[#161616] text-white md:w-2/3 lg:w-3/5">
            <!-- Header -->
            <div id="popup-header" class="flex w-full items-center justify-between">
                <h3 class="title w-1/3">{{ popupState.title }}</h3>
                <div class="flex w-1/3 justify-end gap-4">
                    <div class="relative w-full">
                        <input type="text" v-model="searchQuery"
                            class="para h-12 w-full rounded-full border bg-stone-700 px-4 outline-none">
                        <button class="absolute top-1/2 right-4 -translate-y-1/2" v-on:click="onSearchClick">
                            <i data-lucide="search" class="icon-base"></i>
                        </button>
                    </div>
                    <button @@click="closePopup">
                        <i data-lucide="x" class="icon-base text-red-300"></i>
                    </button>
                </div>
            </div>

            <!-- Content -->
            <div class="popup-content relative">
                <!-- 遮罩式 Loading -->
                <div v-if="isLoading"
                    class="absolute inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
                    <span class="loading loading-spinner loading-lg text-white"></span>
                </div>

                <!-- ✅ loading 結束後顯示內容 -->
                <div v-if="!isLoading">
                    <!-- Collects -->
                    <div v-if="popupState.type == 'Collects'">
                        <div class="popup-data">
                            <div v-for="item in popupData[popupState.type]" :key="item.Id">
                                <div class="card">
                                    <img :src="item.imageUrl" alt="" />
                                    <div class="card-body">
                                        <div class="absolute bottom-0 left-0 z-10 flex flex-col gap-2 p-4">
                                            <div class="user">
                                                <img src="" alt="" />
                                                <h2 class="card-title title">{{ item.authorName }}</h2>
                                            </div>
                                            <p class="para">{{ formatDate(item.collectedAt) }}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Notify -->
                    <div v-if="popupState.type == 'Notify'">
                        <div class="popup-data-notify space-y-4">
                            <div v-for="item in popupData[popupState.type]" :key="item.senderName"
                                class="item-center flex justify-between rounded-lg bg-neutral-800 px-4 py-3 transition hover:bg-neutral-700">
                                <div class="flex items-center space-x-4">
                                    <img :src="item.senderAvatarUrl"
                                        class="h-10 w-10 rounded-full border border-gray-600" />
                                    <div>
                                        <p class="font-semibold">{{ item.senderName }}</p>
                                        <p class="text-sm text-gray-400">{{ item.message }}</p>
                                    </div>
                                </div>
                                <div class="flex flex-col items-end space-y-1">
                                    <span class="text-xs text-gray-500">{{ timeAgo(item.sentTime) }}</span>
                                    <button class="text-sm text-blue-400 hover:underline">Reply</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Follows -->
                    <div v-if="popupState.type == 'Follows'">
                        <!-- 載入中 -->
                        <div v-if="isLoading" class="flex items-center justify-center py-10">
                            <span class="loading loading-spinner loading-lg text-white"></span>
                        </div>

                        <!-- Search (預留) -->
                        <div v-if="popupState.type == 'Search'" class="popup-data-search">

                            <!-- 🔍 使用者結果（滑過展開統計，採字串 style 綁定，避免物件語法與 ?.） -->
                            <!-- 🔍 使用者結果（滑過展開統計） -->
                            <div v-if="popupState.type == 'Search' && popupData.Search && popupData.Search.Users && popupData.Search.Users.length > 0"
                                class="space-y-4">
                                <h3 class="subTitle">使用者</h3>

                                <!-- 用 template v-for 確保整塊都在 user 作用域內 -->
                                <template v-for="(user, index) in popupData.Search.Users" :key="'user-' + index">

                                    <!-- 主卡片＋展開容器（一定放在 v-for 內） -->
                                    <div class="overflow-hidden rounded-lg bg-neutral-800 transition hover:bg-neutral-700"
                                        @@mouseenter="onHoverUser(user)" @@mouseleave="user._hover = false">

                                        <!-- 主列 -->
                                        <div class="flex items-center justify-between px-4 py-3">
                                            <div class="flex items-center space-x-4">
                                                <img :src="user.avatarUrl || '/static/img/default-avatar.png'"
                                                    class="h-12 w-12 rounded-full border border-gray-600" />
                                                <div>
                                                    <p class="title">{{ user.displayName }}</p>
                                                    <p class="subTitle text-sm text-gray-400">{{ user.bio }}</p>
                                                </div>
                                            </div>
                                            <div class="flex flex-col items-end justify-between space-y-1">
                                                <button class="cts-btn !text-blue-400 hover:underline">查看</button>
                                            </div>
                                        </div>

                                        <!-- 展開區：用字串 style 綁定避免物件語法 -->
                                        <div class="overflow-hidden bg-neutral-900 transition-all duration-300 ease-in-out"
                                            :style="(user && user._hover) ? 'max-height:96px' : 'max-height:0px'">

                                            <div class="px-4 py-3">
                                                <!-- 已載入統計 -->
                                                <div v-if="user && user.stats" class="grid grid-cols-2 gap-4">
                                                    <div class="text-center">
                                                        <div class="text-xl font-extrabold">{{ user.stats.following }}
                                                        </div>
                                                        <div class="text-xs text-gray-400">追蹤數</div>
                                                    </div>
                                                    <div class="text-center">
                                                        <div class="text-xl font-extrabold">{{ user.stats.followers }}
                                                        </div>
                                                        <div class="text-xs text-gray-400">被追蹤數</div>
                                                    </div>
                                                </div>

                                                <!-- 載入中 / 提示 -->
                                                <div v-else class="text-sm text-gray-400">
                                                    <span v-if="user && user._loadingStats">載入中…</span>
                                                    <span v-else>滑過以載入統計</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                            </div>

                            <!-- 🏷️ Hashtag 結果 -->
                            <!-- 🏷️ Hashtag（避免 ?.，用最兼容的判斷） -->
                            <div v-if="popupState.type == 'Search' && popupData.Search && popupData.Search.Hashtags && popupData.Search.Hashtags.length > 0"
                                class="mt-6">
                                <h3 class="subTitle mb-2">標籤</h3>
                                <div class="flex flex-wrap gap-2">
                                    <button v-for="(tag, index) in popupData.Search.Hashtags" :key="'tag-' + index"
                                        class="inline-block rounded-full border border-gray-600 bg-neutral-800 px-3 py-2 text-sm whitespace-nowrap text-white transition hover:bg-neutral-700">
                                        #{{ tag.content }}
                                    </button>
                                </div>
                            </div>


                            <!-- ❌ 沒有任何結果 -->
                            <div v-if="popupData.Search?.Users?.length === 0 && popupData.Search?.Hashtags?.length === 0 && searchQuery.trim() !== ''"
                                class="mt-8 text-center text-gray-400">
                                沒有找到符合「{{ searchQuery }}」的使用者或標籤。
                            </div>
                        </div>
                    </div>


                    <!-- Search (預留) -->
                    <div v-if="popupState.type == 'Search'" class="popup-data-search">

                        <!-- 🔍 使用者結果 -->
                        <div v-if="popupData.Search?.Users?.length > 0" class="space-y-4">
                            <h3 class="subTitle">使用者</h3>
                            <div v-for="(user, index) in popupData.Search.Users" :key="'user-' + index"
                                class="flex items-center justify-between rounded-lg bg-neutral-800 px-4 py-3 transition hover:bg-neutral-700">
                                <div class="flex items-center space-x-4">
                                    <img :src="user.avatarUrl || '/static/img/cute.png'"
                                        class="h-12 w-12 rounded-full border border-gray-600" />
                                    <div>
                                        <p class="title">{{ user.displayName }}</p>
                                        <p class="subTitle text-sm text-gray-400">{{ user.bio }}</p>
                                    </div>
                                </div>
                                <div class="flex flex-col items-end justify-between space-y-1">
                                    <button class="cts-btn !text-blue-400 hover:underline"
                                        @@click="toggleFollow(user.personId, user.isFollowed)">
                                        {{ user.isFollowed ? '取消追蹤' : '追蹤' }}
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- 🏷️ Hashtag 結果 -->
                        <div v-if="popupData.Search?.Hashtags?.length > 0" class="mt-6 space-y-2">
                            <h3 class="subTitle">標籤</h3>
                            <div v-for="(tag, index) in popupData.Search.Hashtags" :key="'tag-' + index"
                                class="rounded-lg bg-neutral-800 px-4 py-3 text-white transition hover:bg-neutral-700">
                                #{{ tag.content }}
                            </div>
                        </div>

                        <!-- ❌ 沒有任何結果 -->
                        <div v-if="popupData.Search?.Users?.length === 0 && popupData.Search?.Hashtags?.length === 0 && searchQuery.trim() !== ''"
                            class="mt-8 text-center text-gray-400">
                            沒有找到符合「{{ searchQuery }}」的使用者或標籤。
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@inject ICustomLocalizer Localizer
@* 這是一張張文章卡片的樣板，會一直重複用 *@
@* TODO: 確保必要資料都有，不然就顯示友善的預設 *@
<li v-for="(item, index) in posts" :key="item.articleId">
    <article class="bg-accent">
        @* 文章開頭：作者是誰、什麼時候 *@
        <div class="post-content_header">
            <a class="author-info" :href="`/Profile/${item?.authorName}`">
                <div class="author-avatar border-2 border-white">
                    <img v-if="item.authorAvatar && !hasError(item, 'avatar')" :src="item.authorAvatar" @@error="handleImageError(item, 'avatar')">
                    <span v-else class="bg-secondary">{{ item?.authorName?.slice(0,1).toUpperCase() }}</span>
                </div>
                <div>
                    <h3 class="font-medium text-white">{{ item.authorName || @Localizer["GuestAccount"] }}</h3>
                    <p class="text-sm text-gray-400">{{ item.createTime }}</p>
                </div>
            </a>
            <div class="posts-state">
                <i data-lucide="heart" class="h-4 w-4"></i>
                <span>{{ item.praiseCount }}</span>
                <i data-lucide="bookmark" class="ml-2 h-4 w-4"></i>
                <span>{{ item.collectCount }}</span>
            </div>
        </div>

        @* 正文來了：文章文字內容 *@
        <div class="mb-4 leading-relaxed text-gray-300">
            {{ item.content }}
        </div>

        @* 附件區：有圖片就秀，壞圖用預設 *@
        <div class="post-content_attachments" v-if="item.attachments && item.attachments.length > 0">
            <div class="post-content_attachments_images"
                v-if="item.attachments.filter(f => f.type.toLowerCase() === 'image').length > 0">
                <div class="img_layout" v-for="img in item.attachments.filter(f => f.type.toLowerCase() === 'image')"
                    :key="img.fileId">
                    <img v-if="!hasError(item, 'image')" :src="img.filePath" :alt="img.fileName" @@error="handleImageError(item, 'image')" />
                    <div v-else class="size-full bg-stone-800 flex items-center justify-center">
                        <i data-lucide="image" class="text-stone-600 size-24"></i>
                    </div>
                </div>
            </div>

            <div class="post-content_attachments_files"
                v-if="item.attachments.filter(f => f.type.toLowerCase() === 'file').length > 0">
                <div v-for="file in item.attachments.filter(f => f.type.toLowerCase() === 'file')" :key="file.fileId"
                    class="rounded-md p-2 text-white cursor-pointer transition-colors" style="background: #555;">
                    <a :href="file.filePath" :download="file.fileName" target="_blank" rel="noopener noreferrer"
                        class="flex items-center gap-1">
                        <i data-lucide="file-text" class="size-6 text-stone-300"></i>
                        {{ file.fileName }}
                    </a>
                </div>
            </div>
        </div>

        <!-- 這些是 #標籤，幫你快速分類查找 -->
        <div v-if="item.hashtags" class="mt-4 flex flex-wrap gap-2">
            <span v-for="tag in item.hashtags" :key="tag.tagId" class="rounded-full text-[#333] px-3 py-1 text-sm whitespace-nowrap bg-[#ffda78]">
                #{{ tag.name }}
            </span>
        </div>

        @* 動作列：按讚、留言、收藏（要登入才看得到） *@
        <div class="post-content_state" v-if="currentUser?.isAuthenticated">
            <button :disabled="item._busy" v-on:click="stateFunc('praise', item)">
                <span class="inline-flex items-center gap-1" :class="item.isPraised ? 'text-red-500' : 'text-gray-400'">
                    <i data-lucide="thumbs-up" class="size-4" :class="item.isPraised ? 'currentColor' : 'none'"></i>
                    <span data-i18n="Praise">@Localizer["Praise"]</span>
                    @* <span class="ml-1">{{ item.praiseCount }}</span> *@
                </span>
            </button>
            <button v-on:click="stateFunc('comment', item)">
                <i data-lucide="message-circle" class="size-4"></i>
                <span data-i18n="Comment">@Localizer["Comment"]</span>
            </button>

            <button :disabled="item._busy" v-on:click="stateFunc('collect', item)">
                <span class="inline-flex items-center gap-1"
                    :class="item.isCollected ? 'text-yellow-500' : 'text-gray-400'">
                    <i data-lucide="bookmark" class="size-4" :class="item.isCollected ? 'currentColor' : 'none'"></i>
                    <span data-i18n="Collect">@Localizer["Collect"]</span>
                    @* <span class="ml-1">{{ item.collectCount }}</span> *@
                </span>
            </button>
            <button :disabled="item._busy" v-on:click="stateFunc('report', item)">
                <i data-lucide="flag" class="size-4"></i>
                <span>Report</span>
            </button>


        </div>

        @* 沒登入：貼心提醒一下 *@
        <div class="post-content_state" v-else>
            <div class="flex items-center gap-3 text-sm text-gray-400">
                <i data-lucide="lock" class="size-4"></i>
                <span data-i18n="GuestBrowseMsg">@Localizer["GuestBrowseMsg"]</span>
            </div>
        </div>
    </article>
</li>

<!-- 讀取中：等等我，馬上好！ -->
<li v-if="isLoading" class="py-8 text-center">
    <div class="flex items-center justify-center gap-2 text-gray-400">
        <img src="~/static/img/Loading.gif" alt="Loading" class="h-6 w-6" />
        <span>載入中...</span>
    </div>
</li>

<!-- 已經沒東西啦：滑到結尾了 -->
<li v-if="!hasMorePosts && posts.length > 0" class="text-center py-8">
    <span class="text-gray-400">已顯示所有文章</span>
</li>

<!-- 空空的：還沒有人發文耶 -->
<li v-if="!isLoading && posts.length === 0" class="py-8 text-center">
    <span class="text-gray-400">還沒有發布任何文章</span>
</li>

<!-- 滑到這裡就會去抓更多文章（看不見的小幫手） -->
<div class="infinite-scroll-trigger" style="height: 1px;"></div>

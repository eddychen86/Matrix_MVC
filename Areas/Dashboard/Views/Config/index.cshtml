@inject ICustomLocalizer Localizer
@{
    ViewData["Title"] = Localizer["Config_Title"];
}

<div id="adminConfig" class="w-full h-full">
    <template v-if="isLoading">
        <div class="flex h-[50vh] w-full items-center justify-center">
            <div class="flex flex-col items-center gap-4">
                <img src="~/static/img/Loading.gif" alt="Loading" class="h-16 w-16" />
                <span class="text-gray-700">Loading</span>
            </div>
        </div>
    </template>
    <template v-else>
        <div class="flex flex-col gap-8">
            <h1 class="text-3xl font-bold text-gray-700 col-span-1 sm:col-span-4" data-i18n="Config_Title">@Localizer["Config_Title"]</h1>

            @* 管理員列表 *@
            <div class="grid grid-cols-1 sm:grid-cols-4 gap-8">
                <div class="tabs tabs-lift col-span-1">
                    @* 篩選列表 *@
                    <input type="radio" name="config_tabs" class="tab subTitle" aria-label="@Localizer["Config_Filter"]" checked="checked" />
                    <div class="tab-content border-black/10 p-6">
                        @* 管理員 *@
                        <div class="flex flex-col gap-4">
                            <h3 class="subTitle font-semibold" data-i18n="Config_AdminList">@Localizer["Config_AdminList"]</h3>
                            <ul class="flex flex-col gap-4">
                                <li v-for="tool in adminFilter" :key="tool.id">
                                    <div v-if="tool.type === 'text'" class="flex flex-col gap-2">
                                        <h5 class="subTitle" :data-i18n="`Config_AdminList_${tool.title}`">@Localizer["`Config_AdminList_${tool.title}`"]</h5>
                                        <label class="input">
                                            <i data-lucide="search" class="h-[1em] opacity-50"></i>
                                            <input type="search" v-model="adminFilterVal?.[tool.title]" data-i18n-placeholder="" placeholder="@Localizer[""]" />
                                        </label>
                                    </div>
                                    <div v-else-if="tool.type === 'switch'" class="flex items-center justify-between">
                                        <h5 class="subTitle" :data-i18n="`Config_AdminList_${tool.title}`">@Localizer["`Config_AdminList_${tool.title}`"]</h5>
                                        <label class="toggle text-base-content">
                                            <input type="checkbox" v-model="adminFilterVal?.[tool.title]" />
                                            <i data-lucide="check" class="size-6"></i>
                                            <i data-lucide="x" class="size-6"></i>
                                        </label>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </div>

                    @* 新增「管理員」 *@
                    <input type="radio" name="config_tabs" class="tab subTitle" aria-label="@Localizer["Config_Add_Admin"]" />
                    <div class="tab-content border-black/10 p-6">
                        <form v-on:submit.prevent="submitCreateAdmin" class="space-y-1">
                            @* 頭像上傳 *@
                            <fieldset class="fieldset">
                                <legend class="fieldset-legend" data-i18n="Avatar">@Localizer["Avatar"]</legend>
                                <div class="flex items-center text-center gap-4">
                                    <div class="avatar cursor-pointer mask mask-squircle h-16 w-16" @@click="triggerFileUpload">
                                        <img v-if="formData.avatarPreview" :src="formData.avatarPreview" alt="Avatar Preview" />
                                        <div v-else class="flex items-end justify-center pt-4 px-2 bg-gray-300">
                                            <i data-lucide="user-round" class="size-12"></i>
                                        </div>
                                    </div>
                                    <input type="file" ref="fileInput" class="hidden" accept="image/*" @@change="handleAvatarUpload" />
                                </div>
                            </fieldset>

                            @* 使用者名稱 *@
                            <fieldset class="fieldset">
                                <legend class="fieldset-legend" data-i18n="UserName">@Localizer["UserName"]</legend>
                                <label class="input validator rounded-full">
                                    <i data-lucide="user" class="size-4 opacity-50"></i>
                                    <input type="text" v-model="formData.userName"
                                            placeholder="@Localizer["UserNamePlaceholder"]" data-i18n-placeholder="UserNamePlaceholder"
                                            required minlength="3" maxlength="20" pattern="[A-Za-z][A-Za-z0-9\\-]*" 
                                            title="@Localizer["User_UserNameAllowedChars"]" />
                                </label>
                                <p v-show="formData.userName && !isValidUserName(formData.userName)" class="validator-hint" data-i18n="User_UserNameLength3To20">@Localizer["User_UserNameLength3To20"]</p>
                            </fieldset>

                            @* Email *@
                            <fieldset class="fieldset">
                                <legend class="fieldset-legend" data-i18n="Email">@Localizer["Email"]</legend>
                                <label class="input validator rounded-full">
                                    <i data-lucide="mail" class="size-4 opacity-50"></i>
                                    <input type="email" v-model="formData.email" 
                                            placeholder="@Localizer["EmailPlaceholder"]" data-i18n-placeholder="EmailPlaceholder"
                                            required maxlength="100" 
                                            title="@Localizer["User_EmailInvalid"]" />
                                </label>
                                <p v-show="formData.email && !isValidEmail(formData.email)" class="validator-hint" data-i18n="User_EmailInvalid">@Localizer["User_EmailInvalid"]</p>
                            </fieldset>

                            @* 密碼 *@
                            <fieldset class="fieldset">
                                <legend class="fieldset-legend" data-i18n="Password">@Localizer["Password"]</legend>
                                <label class="input validator rounded-full">
                                    <i data-lucide="key" class="size-4 opacity-50"></i>
                                    <input type="password" v-model="formData.password" 
                                            placeholder="@Localizer["PasswordPlaceholder"]" data-i18n-placeholder="PasswordPlaceholder"
                                            required minlength="8" maxlength="20" pattern="(?=.*\\d)(?=.*[a-z])(?=.*[A-Z])(?=.*[#@@$!%*?&amp;]).{8,}" 
                                            title="@Localizer["User_PasswordComplexity"]" />
                                </label>
                                <p v-show="formData.password && !isValidPassword(formData.password)" class="validator-hint" data-i18n="User_PasswordComplexity">@Localizer["User_PasswordComplexity"]</p>
                            </fieldset>

                            @* 確認密碼 *@
                            <fieldset class="fieldset">
                                <legend class="fieldset-legend" data-i18n="ConfirmPassword">@Localizer["ConfirmPassword"]</legend>
                                <label class="input validator rounded-full">
                                    <i data-lucide="key" class="size-4 opacity-50"></i>
                                    <input type="password" v-model="formData.passwordConfirm" 
                                            placeholder="@Localizer["ConfirmPasswordPlaceholder"]" data-i18n-placeholder="ConfirmPasswordPlaceholder"
                                            required 
                                            title="@Localizer["User_PasswordsMustMatch"]" />
                                </label>
                                <p v-show="formData.passwordConfirm && formData.password !== formData.passwordConfirm" class="validator-hint" data-i18n="User_PasswordsMustMatch">@Localizer["User_PasswordsMustMatch"]</p>
                            </fieldset>

                            @* 角色選擇（僅超級管理員可見） *@
                            <fieldset v-if="userPermissions.role === 2" class="fieldset">
                                <legend class="fieldset-legend" data-i18n="Users_RoleText">@Localizer["Users_RoleText"]</legend>
                                <select v-model="formData.role" class="select select-primary rounded-full">
                                    <option value="1" data-i18n="Config_AdminList_Admin">@Localizer["Config_AdminList_Admin"]</option>
                                    <option value="2" data-i18n="Config_AdminList_SuperAdmin">@Localizer["Config_AdminList_SuperAdmin"]</option>
                                </select>
                            </fieldset>

                            @* 提交按鈕 *@
                            <div class="card-actions justify-center">
                                <button type="button" 
                                        @@click="cancelCreateAdmin" 
                                        class="btn btn-ghost">
                                    <span data-i18n="Cancel">Cancel</span>
                                </button>
                                <button type="submit" 
                                        :disabled="isSubmitting" 
                                        class="btn btn-primary">
                                    <span v-if="isSubmitting" class="loading loading-spinner loading-sm"></span>
                                    <span data-i18n="Create">Create</span>
                                </button>
                            </div>
                        </form>                       
                    </div>
                </div>

                <div class="col-span-1 sm:col-span-3">
                    <div class="overflow-x-auto bg-yellow-50 rounded-2xl border border-black/10 min-h-[500px]">
                        <table class="table table-pin-rows table-pin-cols">
                            <!-- head -->
                            <thead>
                                <tr class="text-center bg-yellow-50">
                                    <td v-for="head in adminList.header" :key="head.title" :class="head.class" :data-i18n="head.title"></td>
                                    <th class="bg-yellow-50"></th>
                                </tr>
                            </thead>

                            <tbody class="subTitle">
                                <tr v-for="item in adminList.data" :key="item.id" class="hover:bg-yellow-100">
                                    <td>
                                        <div class="flex items-center gap-3">
                                            <div class="avatar">
                                                <div class="mask mask-squircle h-12 w-12" :class="!item.Avatar ? 'flex items-end justify-center pt-3 px-1 bg-gray-300' : ''">
                                                    <img v-if="item.Avatar" :src="item.Avatar" :alt="item.UserName" :title="item.UserName" />
                                                    <i v-else data-lucide="user-round" class="size-10"></i>
                                                </div>
                                            </div>
                                            <div class="flex flex-col gap-1">
                                                <div class="font-bold">{{ item.UserName }}</div>
                                                <div class="text-sm opacity-50">{{ item.email }}</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>{{ item.DisplayName }}</td>
                                    <td class="text-center">
                                        <div :data-i18n="item.SuperAdmin === 2 ? 'Yes' : 'No'"></div>
                                    </td>
                                    <td class="flex justify-center">
                                        <div class="rounded-full text-center text-white w-20 shadow-xl/30 border-2"
                                                :class="item.status === 1 ? 'bg-green-500 border-green-300 shadow-green-300' : 'bg-red-500 border-red-300 shadow-red-300'"
                                                :data-i18n="item.status === 1 ? 'enable' : 'disable'"
                                                ></div>
                                    </td>
                                    <th class="text-center bg-yellow-50">
                                        <div class="join">
                                            <button class="btn btn-ghost rounded-md btn-sm px-2 py-1" @@click="editAdmin(item.id)">
                                                <i data-lucide="pen" class="size-6 text-blue-500 cursor-pointer"></i>
                                            </button>
                                            <button class="btn btn-ghost rounded-md btn-sm px-2 py-1" @@click="delAdmin(item.id)">
                                                <i data-lucide="trash-2" class="size-6 text-red-500 cursor-pointer"></i>
                                            </button>
                                        </div>
                                    </th>
                                </tr>
                            </tbody>

                            <!-- foot -->
                            <tfoot v-if="adminList.data.length > adminList_pageSize">
                                <tr>
                                    <td colspan="6" class="bg-yellow-50">
                                        <div class="flex items-center justify-center w-full py-2">
                                            <div class="join">
                                                <button class="join-item bg-white btn" @@click="togglePrevPage">
                                                    <i data-lucide="chevron-left" class="size-8 text-black"></i>
                                                </button>
                                                <button class="join-item btn"
                                                        :class="adminList_curPage === 1 ? 'bg-blue-500 text-white' : 'bg-white'"
                                                        @@click="toggleFirstPage"
                                                        >1</button>

                                                <button class="join-item bg-white btn btn-disabled"
                                                        v-if="adminList_curPage >= 3"
                                                        >...</button>
                                                <button class="join-item bg-blue-500 text-white btn"
                                                        v-if="adminList_curPage > 1 && adminList_curPage < adminList_pageSize"
                                                        >{{ adminList_curPage }}</button>
                                                <button class="join-item bg-white btn btn-disabled"
                                                        v-if="adminList_curPage <= adminList_pageSize - 2"
                                                        >...</button>

                                                <button class="join-item btn"
                                                        :class="adminList_curPage === adminList_pageSize ? 'bg-blue-500 text-white' : 'bg-white'"
                                                        @@click="toggleLastPage"
                                                        >{{ adminList_pageSize }}</button>
                                                <button class="join-item bg-white btn" @@click="toggleNextPage">
                                                    <i data-lucide="chevron-right" class="size-8 text-black"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>

            @* 日誌 *@
            <div class="grid grid-cols-1 sm:grid-cols-4 gap-8">
                <div class="flex flex-col gap-4 col-span-1">
                    <h3 class="subTitle font-semibold" data-i18n="Config_WebLog">@Localizer["Config_WebLog"]</h3>
                    <ul class="flex flex-col gap-4">
                        <li v-for="tool in logFilter" :key="tool.id">
                            <div v-if="tool.type === 'text'" class="flex flex-col gap-2">
                                <h5 class="subTitle" :data-i18n="`Config_AdminList_${tool.title}`">@Localizer["`Config_AdminList_${tool.title}`"]</h5>
                                <label class="input">
                                    <i data-lucide="search" class="h-[1em] opacity-50"></i>
                                    <input type="search" v-model="logFilterVal?.[tool.title]" data-i18n-placeholder="" placeholder="@Localizer[""]" />
                                </label>
                            </div>
                            <div v-else-if="tool.type === 'switch'" class="flex items-center justify-between">
                                <h5 class="subTitle" :data-i18n="`Config_AdminList_${tool.title}`">@Localizer["`Config_AdminList_${tool.title}`"]</h5>
                                <label class="toggle text-base-content">
                                    <input type="checkbox" v-model="logFilterVal?.[tool.title]" />
                                    <i data-lucide="check" class="size-6"></i>
                                    <i data-lucide="x" class="size-6"></i>
                                </label>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </template>
</div>

@section Scripts {
    <script src="~/js/dashboard/pages/config/config.js" asp-append-version="true"></script>
}
